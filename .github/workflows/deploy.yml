name: Deploy to AWS Lambda

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Utilities
        run: sudo apt-get install -y zip

      - name: Install Dependencies
        run: npm ci

      - name: Build Lambda Artifact
        run: npx tsx scripts/build-lambda.ts

      - name: Create Zip Package
        run: |
          cd dist
          zip -r ../function.zip .

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Deploy to Lambda
        run: |
          aws lambda update-function-code \
            --function-name ${{ vars.LAMBDA_FUNCTION_NAME }} \
            --zip-file fileb://function.zip

      - name: Verify Deployment (Health Check)
        shell: bash
        env:
          API_URL: "https://${{ vars.AWS_API_ID }}.execute-api.${{ vars.AWS_REGION }}.amazonaws.com"
        run: |
          echo "Target API: $API_URL"
          MAX_RETRIES=5
          
          # Check paths in loop
          for PATH_TO_CHECK in "/health" "/api/health"; do
            echo "----------------------------------------"
            echo "Checking $PATH_TO_CHECK ..."
            SUCCESS=false
            
            for ((i=1; i<=MAX_RETRIES; i++)); do
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL$PATH_TO_CHECK")
              RESPONSE=$(curl -s "$API_URL$PATH_TO_CHECK")
              
              if [ "$HTTP_CODE" -eq 200 ]; then
                if echo "$RESPONSE" | grep -q '"status".*"ok"'; then
                  echo "âœ… Success: $PATH_TO_CHECK (Attempt $i)"
                  SUCCESS=true
                  break
                else
                  echo "âš ï¸ Status 200 but content verify failed. Response: $RESPONSE"
                  echo "Retrying... ($i/$MAX_RETRIES)"
                fi
              else
                echo "âš ï¸ Failed: HTTP $HTTP_CODE. Retrying... ($i/$MAX_RETRIES)"
              fi
              
              if [ $i -lt $MAX_RETRIES ]; then
                sleep 3
              fi
            done
            
            if [ "$SUCCESS" = false ]; then
              echo "âŒ Final Failure: $PATH_TO_CHECK after $MAX_RETRIES attempts"
              exit 1
            fi
          done
          
          echo "ðŸŽ‰ All checks passed!"
