name: Deploy to AWS Lambda

on:
  push:
    branches:
      - main
      - develop

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # í™˜ê²½ë³€ìˆ˜ ê²°ì • ë¡œì§ (ë¸Œëœì¹˜ì— ë”°ë¼ ë‹¤ë¥¸ Secret ì„ íƒ)
    env:
      LAMBDA_NAME: ${{ github.ref == 'refs/heads/main' && secrets.PROD_LAMBDA_NAME || secrets.DEV_LAMBDA_NAME }}
      DDB_TABLE: ${{ github.ref == 'refs/heads/main' && secrets.PROD_DDB_TABLE || secrets.DEV_DDB_TABLE }}
      S3_BUCKET: ${{ github.ref == 'refs/heads/main' && secrets.PROD_S3_BUCKET || secrets.DEV_S3_BUCKET }}
      API_ID: ${{ github.ref == 'refs/heads/main' && vars.AWS_API_ID || vars.DEV_AWS_API_ID }}
      # í™˜ê²½ë³„ ìƒìˆ˜ ì„¤ì •
      ENV_NAME: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
      MENU_CACHE_ENABLED: "true"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Utilities
        run: sudo apt-get install -y zip

      - name: Install Dependencies
        run: npm ci

      - name: Build Lambda Artifact
        run: npx tsx scripts/build-lambda.ts

      - name: Create Zip Package
        run: |
          cd dist
          zip -r ../function.zip .

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Deploy to Lambda
        run: |
          echo "Deploying to function: $LAMBDA_NAME"
          
          # 1. ì½”ë“œ ì—…ë°ì´íŠ¸
          aws lambda update-function-code \
            --function-name $LAMBDA_NAME \
            --zip-file fileb://function.zip

          # 2. í™˜ê²½ë³€ìˆ˜ ì—…ë°ì´íŠ¸ (Wait for code update to finish / Code update is async but usually fast)
          # ì ì‹œ ëŒ€ê¸°í•˜ì—¬ ì—…ë°ì´íŠ¸ ì¶©ëŒ ë°©ì§€
          sleep 5

          echo "Updating configuration for: $LAMBDA_NAME"
          echo "Setting DDB_TABLE_WAITING=$DDB_TABLE"
          echo "Setting S3_BUCKET=$S3_BUCKET"
          
          aws lambda update-function-configuration \
            --function-name $LAMBDA_NAME \
            --environment "Variables={
              AWS_REGION=${{ vars.AWS_REGION }},
              DDB_TABLE_WAITING=$DDB_TABLE,
              S3_BUCKET=$S3_BUCKET,
              WAITING_SOURCE=ddb,
              MENU_SOURCE=s3,
              MENU_CACHE_ENABLED=$MENU_CACHE_ENABLED,
              NODE_ENV=$ENV_NAME
            }"

      - name: Verify Deployment (Health Check)
        shell: bash
        env:
          # API Gateway URL êµ¬ì„± (env.API_ID ì‚¬ìš©)
          API_URL: "https://${{ env.API_ID }}.execute-api.${{ vars.AWS_REGION }}.amazonaws.com/${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}"
        run: |
          echo "Target API: $API_URL"
          MAX_RETRIES=5
          
          # Check paths in loop
          # /health (Lambda URL/API GW root) and /api/health (App router)
          for PATH_TO_CHECK in "/health" "/api/health"; do
            echo "----------------------------------------"
            echo "Checking $PATH_TO_CHECK ..."
            SUCCESS=false
            
            for ((i=1; i<=MAX_RETRIES; i++)); do
              # -L to follow redirects if any
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L "$API_URL$PATH_TO_CHECK")
              RESPONSE=$(curl -s -L "$API_URL$PATH_TO_CHECK")
              
              if [ "$HTTP_CODE" -eq 200 ]; then
                if echo "$RESPONSE" | grep -q '"status".*"ok"'; then
                  echo "âœ… Success: $PATH_TO_CHECK (Attempt $i)"
                  SUCCESS=true
                  break
                else
                  echo "âš ï¸ Status 200 but content verify failed. Response: $RESPONSE"
                  echo "Retrying... ($i/$MAX_RETRIES)"
                fi
              else
                echo "âš ï¸ Failed: HTTP $HTTP_CODE. Retrying... ($i/$MAX_RETRIES)"
              fi
              
              if [ $i -lt $MAX_RETRIES ]; then
                sleep 5
              fi
            done
            
            if [ "$SUCCESS" = false ]; then
              echo "âŒ Final Failure: $PATH_TO_CHECK after $MAX_RETRIES attempts"
              echo "Note: If this is a new deployment, API Gateway might need a moment to propagate."
              # We don't exit 1 here immediately to check other paths, or just warn.
              # But for strict CI, we should probably fail.
              exit 1
            fi
          done
          
          echo "ğŸ‰ All checks passed!"
